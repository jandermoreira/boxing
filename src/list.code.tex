%! Author = Jander Moreira
%! Date = 07/10/2022

%! suppress = MultipleIncludes

\NewCommandCopy\boxing@OriginalItem\item

\newif\ifboxing@UseEnumItem
\@ifpackageloaded{enumitem}{
    \boxing@UseEnumItemtrue
}{
    \boxing@UseEnumItemfalse
}

\NewCounter{boxing@ItemLevel}
\NewCounter{boxing@Level1Counter}
\NewCounter{boxing@Level2Counter}

\NewDocumentCommand{\EnumerateItem}{ +m }{%
    \UsePalette{\boxing@Palette}%
    \StepPalette{\boxing@Palette}%
    \ProcessItemArguments{\l@overlay}{\l@option}{\l@text}{#1}%
    %! formatter = off
    \ifx\l@option\empty
        \boxing@OriginalItem{\color{\CurrentBGColor}\l@text}%
    \else
        \boxing@OriginalItem[\l@option]{\color{\CurrentBGColor}\l@text}%
    \fi%
    %! formatter = on
    \StepCounter{boxing@Level\theboxing@ItemLevel Counter}%
}

\NewDocumentCommand{\boxing@SetEnumerate}{ }{
\let\boxing@OriginalEnumerate\enumerate
\let\endboxing@OriginalEnumerate\endenumerate
\RenewDocumentEnvironment{enumerate}{ O{} D<>{} +b }{
    \begin{boxingitems}{boxing@OriginalEnumerate}[##1]<##2>
        ##3
            }{
    \end{boxingitems}
}
}
%! formatter = off
\ifboxing@UseEnumerate
    \boxing@SetEnumerate
\fi
%! formatter = on

% colorenumerate: enumerated list using a color palette
% #1: environment to be used (e.g. itemize, enumerate)
% #2: optional parameters to the environment in #1 (brackets)
% #3: boxing options (angle brackets)
\newif\ifboxing@UseOptionalArguments
\NewDocumentCommand{\boxing@BeginEnvironment}{}{}
\NewDocumentCommand{\boxing@EndEnvironment}{}{}
\NewDocumentCommand{\l@environmentoptions}{}{}
\NewDocumentEnvironment{boxingitems}{ m O{} D<>{} +b }{%
    \begingroup%
    \StepCounter{boxing@ItemLevel}%
    \gatheritems{#4}%
    \boxingset{#3}%
    % \IsEmpty{#2}{%
    %     \boxing@UseOptionalArgumentsfalse%
    % }{%
    %     \boxing@UseOptionalArgumentstrue%
    % }%
    \RenewDocumentCommand{\boxing@BeginEnvironment}{}{%
        \csname #1\endcsname%
    }%
    \RenewDocumentCommand{\boxing@EndEnvironment}{}{%
        \csname end#1\endcsname%
    }%
    %
    \IsEmpty{#2}{%
        \boxing@OriginalEnumerate[#2]%
    }{%
        \boxing@OriginalEnumerate%
    }%
    \loopthroughitemswithcommand{\EnumerateItem}%
    \endboxing@OriginalEnumerate%
    \AddToCounter{boxing@ItemLevel}{-1}
    \endgroup%
    }{%
}

\ExplSyntaxOn
\cs_generate_variant:Nn \seq_clear_new:N { c }

\cs_new:Npn \int_clear_new:N #1 {
    \int_if_exist:NTF #1 { } {
        \int_new:N #1
    }
}
\cs_generate_variant:Nn \int_clear_new:N { c }

\cs_new:Npn \execute_list_of_items:nn #1#2 {
    \int_clear_new:N \l_number_gathered_items_int
    \int_set:Nn \l_number_gathered_items_int { \thenumgathereditems }

    \tl_clear_new:N \l_item_body_tl
    \int_clear_new:N \l_current_item_int
    \tl_clear_new:N \l_argument_tl
    \int_set:Nn \l_current_item_int { 1 }
    \int_while_do:nn { \l_current_item_int <= \l_number_gathered_items_int } {
        \exp_args:NNc \tl_set:No \l_item_body_tl { getitems@item@\int_use:N \l_current_item_int }
        \tl_set:No \l_argument_tl { \l_item_body_tl }
        \exp_args:No #2 { \l_argument_tl }
        \int_set:Nn \l_current_item_int { \l_current_item_int + 1 }
    }
    \seq_clear:c { g_item_list_level_#1_seq }
}
\NewExpandableDocumentCommand{\ExecuteListOfItems}{ m m }{
    \execute_list_of_items:nn { #1 } { #2 }
}
\ExplSyntaxOff

\RenewDocumentCommand{\loopthroughitemswithcommand}{ m }{%
    \ExecuteListOfItems{\The{boxing@ItemLevel}}{#1}
}